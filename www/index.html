<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Webauthn</title>
</head>

<body>

<script>
function register() {
    // register / create a new credential
    navigator.credentials.create(createCredentialDefaultArgs)
    .then((cred) => {
        console.log("PublicKeyCredential:");
        console.log(cred);
        // id and type inherited from Credential interface
        console.assert(cred.type == 'public-key');
        console.log(".id: " + cred.id); // base64urlencoded
        console.log(".rawId: " + bufferToHex(cred.rawId)); // ArrayBuffer

        console.log(".response:");	// 
        console.log(cred.response);	// AuthenticatorAttestationResponse
        // clientDataJSON inherited from AuthenticatorResponse
        console.log("clientDataJSON: " + bufferToHex(cred.response.clientDataJSON)); // ArrayBuffer
        console.log("attestationObject: " + bufferToHex(cred.response.attestationObject)); // ArrayBuffer
        // cred.id, clientDataJSON, and attestationObject are sent back to server
        document.getElementById("registerForm").elements.namedItem("credId").value = cred.id;
        document.getElementById("registerForm").elements.namedItem("clientDataJSON").value = bufferToHex(cred.response.clientDataJSON);
        document.getElementById("registerForm").elements.namedItem("attestationObject").value = bufferToHex(cred.response.attestationObject);
	cborme = "https://cbor.me/?bytes=" + bufferToHex(cred.response.attestationObject);
        log(`Done, please submit to send data to the server, or view using <a href='${ cborme }'>cbor.me</a>`);
    }).catch((err) => {console.error("oops:" + err)});

};
</script>

<div id="container">
    <h1>RP ID Hash test</h1>
    <div id="result" class="status"></div>
    <button id="register" onClick=register()>navigator.credentials.create</button>
    <form id="registerForm" method="post" action="register.php">
        <input type="hidden" name="clientDataJSON" />
	<textarea name="attestationObject" rows="8" cols="64" readonly>
	</textarea>
        <input type="hidden" id="credId" name="credId" />
	<br/>
        <input type="submit" value="submit" />
    </form>
</div>

<div id="message" class="info">Enable javascript console to view log messages</div>

<script>
if( navigator.credentials==undefined ) console.error("credentials API unavailable");
if (!window.PublicKeyCredential) console.error("Web Authentication API unavailable");

function bufferToHex (buffer) {
    return Array
        .from (new Uint8Array (buffer))
        .map (b => b.toString (16).padStart (2, "0"))
        .join ("");
}

function log(msg) {
    var m = document.getElementById("message");
    m.innerHTML += '<br/>' + msg;
}

const ES256 = -7; // ECDSA w/ SHA-256

var createCredentialDefaultArgs = {
    publicKey: {
        rp: {
            name: "Test RP",
        },
        user: {
            id: new TextEncoder().encode("dummy id"),
            name: "test",
            displayName:  "Test User"
        },
        pubKeyCredParams: [
            {
                type: "public-key",
                alg: ES256
            }
        ],
        challenge: new Uint8Array([ 1,2,3,4,5,6,7,8 ]).buffer,
        authenticatorSelection: {
          authenticatorAttachment: "cross-platform",
          userVerification: "discouraged"
        },
    }
};
console.log(createCredentialDefaultArgs);
</script>

</body>
</html>
