# Safari RpIdHash

Simple, quick & dirty WebAuthn demo to illustrate an issue with Safari 16.0, 16.1 (and possibly earlier versions).

## The issue

The seems to be an issue with Apple's Safari browser implementation of WebAuthn.
When using a U2F (CTAP1) security key, the WebAuthn `navigator.credential.create` call returns an attestation object with a non-matching RP Id Hash.

See the Webauthn spec's definition of <a href="https://www.w3.org/TR/webauthn-2/#relying-party-identifier">relying-party-identifier</a>:

- RP ID - a valid domain string identifying the WebAuthn Relying Party [...]
By default, the RP ID for a WebAuthn operation is set to the caller's origin's effective domain.</em>

and

- rpIdHash (32 bytes): SHA-256 hash of the RP ID the credential is scoped to.

The problem arises when the RP verifies the RpIdHash when for instance registering a new credential:
See the WebAuthn spec for the procedure for <a href="https://www.w3.org/TR/webauthn-2/#sctn-registering-a-new-credential">registering-a-new-credential</a>:

- 13 Verify that the rpIdHash in authData is the SHA-256 hash of the RP ID expected by the Relying Party.

Note that this issue only occurs with U2F (CTAP1). When using a FIDO2 security key (CTAP2) the resulting RpIdHash is correct.

# Installing the demo

## Install locally

As the issue is with Safari, we only provide instructions for MacOS.

The server is implemented with PHP. As PHP is no longer distributed with MacOS (at least not with MacOS 12 and 13), use <a href="https://brew.sh">brew.sh</a> to install it:

    brew install php

Also required is <a href="https://getcomposer.org">Composer</a>, as the server uses <a href="https://github.com/2tvenom/CBOREncode">2tvenom/CBOREncode</a> for decoding CBOR data.

    brew install composer

To run on your local system, simply clone this repository and run composer to install the dependency:

    composer install

Then use the PHP builtin web server to run the web application:

    php -S localhost:8000 -t www

## Testing a non-localhost RP ID

To test with an RP ID other than localhost, use a reverse proxy on an HTTPS endpoint that tunnels back to your localhost.
See <a href="https://github.com/anderspitman/awesome-tunneling">here</a> for some options.

As an example, install <a href="https://ngrok.com/">ngrok</a>:

    brew install ngrok

and run a reverse proxy using:

    ngrok http 8000

where the local port number should match your PHP server's listening port.
Then point your browser to the HTTPS URL generated by ngrok to run the demo through the reverse proxy on your local machine.
Note that by default *anyone* can connect to that URL so be careful and kill your tunnel immediately after testing.

## Testing without a server.

You can also test without a server, but you'd need to put the <a href="index.html">index.html</a> file on an HTTPS site.
Instead of submitting the form with `attestationObject` data, click the link to <a href="cbor.me">cbor.me</a> to decode your browser's `attestationObject` and observe the first 32 bytes (i.e. first 64 hex digits) from the `authData` component.

See <a href="https://cbor.me/?bytes=a363666d74646e6f6e656761747453746d74a068617574684461746158c449960de5880e8c687434170f6476605b8fe4aeb9a28632c7995cf3ba831d9763450000011c000000000000000000000000000000000040d2a024df249af06f9e5e1e297b02d3092a6ca38907389346a290eff38966ab31699a00613af0fbc78d927681dbd978daca242c69541c2c823507c18e3aa9eaffa50102032620012158202a8b5bfa47cdb5f4bfc0b164865a21f61080bf064c59dc205bfc56aa1bcd066222582066b947585458d39c2a918ca578ed33a8167504ce20438c007cbb61857290fa57">this</a> URL as an example.

###

Alternatively, you can use command line tools like <a href="https://www.npmjs.com/package/cbor-cli">cbor-cli</a> and <a href="https://stedolan.github.io/jq/">jq</a> to decode the `attestationObject`:

    brew install npm
    npm install -g cbor-cli
    brew install jq

Copy the hex data output to your pasteboard (the Clipboard) and run the following from the command line to extract the RP Hash ID::

    pbpaste | xxd -r -p | cbor2json | jq '.authData.data | .[0:32] | .[]' | perl -ne 'printf("%02x",$_)'

